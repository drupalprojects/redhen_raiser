<?php
/**
 * @file
 * Code for the RedHen Raiser Campaign Updates feature.
 */

include_once 'redhen_raiser_campaign_updates.features.inc';

/**
 * Implements hook_node_view_alter().
 */
function redhen_raiser_campaign_updates_node_view_alter(&$build) {
  if ($build['#bundle'] == "campaign_update") {
    // Show author image, and sometimes name, on Campaign Updates.
    $node_wrapper = entity_metadata_wrapper("node", $build['#node']);
    $user = $node_wrapper->author->value();
    $redhen_contact = redhen_contact_load_by_user($user);
    switch ($build['#view_mode']) {
      case "full":
        if ($redhen_contact) {
          $build['author'] = entity_view('redhen_contact', array($redhen_contact), 'byline', NULL, TRUE);
        }
        break;

      case "teaser":
        if ($user->picture) {
          $build['avatar'] = array(
            '#theme' => 'image_style',
            '#path' => $user->picture->uri,
            '#style_name' => 'mini-avatar',
            '#weight' => -1,
          );
        }
        break;

    }
  }
}

/**
 * Implements hook_views_query_alter().
 */
function redhen_raiser_campaign_updates_views_query_alter(&$view, &$query) {
  // We want page updates to include general campaign updates.
  if ($view->name == "campaign_updates" && $view->current_display == 'page_block') {
    $query->where[0]['type'] = 'OR';
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function redhen_raiser_campaign_updates_form_campaign_update_node_form_alter(&$form, &$form_state, $form_id) {
  if (!$form['nid']['#value']) {
    // This is a brand new node:
    $params = drupal_get_query_parameters();
    if (!isset($params['page']) && !user_access('edit any campaign_update content')) {
      $access = FALSE;
    }
    else {
      $page = redhen_campaign_page_load($params['page']);
      if (!$page || !redhen_campaign_page_access('edit', $page)) {
        $access = FALSE;
      }
      else {
        // There is a valid page argument and the user has access to edit the
        // page and post updates. Populate the contextual elements.
        $access = TRUE;
        $lang = $form['language']['#value'];
        $form['field_campaign_context'][$lang]['#default_value'] = $page->campaign;
        $form['field_page_context'][$lang]['#default_value'] = $page->page_id;
      }
    }
    if (!$access) {
      drupal_set_message(t('To create an update, go to your Campaign Page and use the "Updates" tab.'), 'warning');
      foreach (element_children($form) as $element) {
        $form[$element]['#access'] = FALSE;
      }
    }
  }
  $form['field_campaign_context']['#access'] = user_access('edit any campaign_update content');
  $form['field_page_context']['#access'] = user_access('edit any campaign_update content');
}
